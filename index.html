<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Pacchi</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
    .login-box { border: 1px solid #ccc; padding: 20px; border-radius: 10px; text-align: center; }
    select, input { padding: 5px; margin: 5px; }
    button { padding: 5px 10px; margin: 5px; }
    h2 { margin-top: 20px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="loginPage" class="login-container">
    <div class="login-box">
      <h2>Accesso</h2>
      <input type="password" id="accessCode" placeholder="Inserisci codice" />
      <br>
      <button onclick="login()">Entra</button>
    </div>
  </div>

  <!-- Pagina principale -->
  <div id="mainPage" class="hidden">
    <button onclick="logout()">Logout</button>

    <h2>Pacchi in giacenza: <span id="counterAttivi">0</span></h2>

    <form id="paccoForm">
      <input type="number" id="codiceRiconoscimento" placeholder="Codice di riconoscimento (solo numeri)" required>
      <input type="text" id="cognome" placeholder="Cognome" required>
      <select id="corriereSelect"></select>
      <select id="scaffaleSelect"></select>
      <button type="submit">Aggiungi Pacco</button>
    </form>

    <div>
      <h3>Gestione Corrieri</h3>
      <input type="text" id="nuovoCorriere" placeholder="Nuovo corriere">
      <button onclick="aggiungiCorriere()">+</button>
      <button onclick="rimuoviCorriere()">-</button>
    </div>

    <div>
      <h3>Gestione Scaffali</h3>
      <input type="text" id="nuovoScaffale" placeholder="Nuovo scaffale">
      <button onclick="aggiungiScaffale()">+</button>
      <button onclick="rimuoviScaffale()">-</button>
    </div>

    <div id="pacchiContainer"></div>

    <div class="sezione-ritirati">
      <h2>Pacchi Ritirati ▼</h2>
      <button id="cancellaRitiratiBtn" style="font-size:14px; padding:5px 10px; margin-bottom:10px;">Cancella pacchi ritirati</button>
      <div id="ritiratiContainer"></div>
    </div>
  </div>

  <script>
    const codiceAccesso = "2025754785478";
    let pacchi = JSON.parse(localStorage.getItem("pacchi")) || [];
    let corrieri = JSON.parse(localStorage.getItem("corrieri")) || ["Tutti","GLS","Bartolini","DHL","Altri Corrieri"];
    let scaffali = JSON.parse(localStorage.getItem("scaffali")) || ["", ...Array.from({length:12}, (_,i)=>`Scaffale ${i+1}`), "Avanti (bancone)"];

    // ---- LOGIN ----
    function login(){
      const input = document.getElementById("accessCode").value;
      if(input === codiceAccesso){
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("mainPage").classList.remove("hidden");
        resetInactivityTimer();
        aggiornaVista();
      } else {
        alert("Codice errato!");
      }
    }

    function logout(){
      document.getElementById("loginPage").classList.remove("hidden");
      document.getElementById("mainPage").classList.add("hidden");
      document.getElementById("accessCode").value="";
      clearTimeout(inactivityTimer);
    }

    // ---- TIMER INATTIVITÀ ----
    let inactivityTimer;
    function resetInactivityTimer(){
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(()=>{
        alert("Sessione scaduta. Reinserisci il codice di accesso.");
        logout();
      }, 20*60*1000);
    }
    document.onmousemove = resetInactivityTimer;
    document.onkeypress = resetInactivityTimer;

    // ---- SALVATAGGIO ----
    function salvaDati(){
      localStorage.setItem("pacchi", JSON.stringify(pacchi));
      localStorage.setItem("corrieri", JSON.stringify(corrieri));
      localStorage.setItem("scaffali", JSON.stringify(scaffali));
    }

    // ---- GESTIONE CORRIERI ----
    function aggiornaCorrieri(){
      const select = document.getElementById("corriereSelect");
      select.innerHTML="";
      corrieri.forEach(c=>{
        const opt = document.createElement("option");
        opt.value=c; opt.textContent=c;
        select.appendChild(opt);
      });
    }
    function aggiungiCorriere(){
      const val = document.getElementById("nuovoCorriere").value.trim();
      if(val && !corrieri.includes(val)){
        corrieri.push(val);
        salvaDati();
        aggiornaCorrieri();
      }
    }
    function rimuoviCorriere(){
      const val = document.getElementById("nuovoCorriere").value.trim();
      if(val && corrieri.includes(val)){
        if(confirm("Vuoi rimuovere anche i pacchi di questo corriere?")){
          pacchi = pacchi.filter(p=>p.corriere!==val);
        }
        corrieri = corrieri.filter(c=>c!==val);
        salvaDati();
        aggiornaCorrieri();
        aggiornaVista();
      }
    }

    // ---- GESTIONE SCAFFALI ----
    function aggiornaScaffali(){
      const select = document.getElementById("scaffaleSelect");
      select.innerHTML="";
      scaffali.forEach(s=>{
        const opt = document.createElement("option");
        opt.value=s; opt.textContent=s;
        select.appendChild(opt);
      });
    }
    function aggiungiScaffale(){
      const val = document.getElementById("nuovoScaffale").value.trim();
      if(val && !scaffali.includes(val)){
        scaffali.push(val);
        salvaDati();
        aggiornaScaffali();
      }
    }
    function rimuoviScaffale(){
      const val = document.getElementById("nuovoScaffale").value.trim();
      if(val && scaffali.includes(val)){
        if(confirm("Vuoi rimuovere anche i pacchi di questo scaffale?")){
          pacchi = pacchi.filter(p=>p.scaffale!==val);
        }
        scaffali = scaffali.filter(s=>s!==val);
        salvaDati();
        aggiornaScaffali();
        aggiornaVista();
      }
    }

    // ---- FORM AGGIUNTA PACCO ----
    document.getElementById("paccoForm").addEventListener("submit", e=>{
      e.preventDefault();
      const codice = document.getElementById("codiceRiconoscimento").value.trim();
      const cognome = document.getElementById("cognome").value.trim();
      const corriere = document.getElementById("corriereSelect").value;
      const scaffale = document.getElementById("scaffaleSelect").value;

      if(!codice || !cognome){
        if(!confirm("Mancano dati obbligatori. Vuoi continuare?")) return;
      }

      if(pacchi.some(p=>p.codice===codice)){
        if(!confirm("Codice già presente. Vuoi continuare?")) return;
      }

      pacchi.push({codice,cognome,corriere,scaffale,ritirato:false,dataRitiro:null});
      salvaDati();
      aggiornaVista();
      e.target.reset();
    });

    // ---- CANCELLA PACCHI RITIRATI (solo corriere selezionato) ----
    document.getElementById('cancellaRitiratiBtn').addEventListener('click', () => {
      const corriere = document.getElementById('corriereSelect').value;
      const ritirati = pacchi.filter(p => p.ritirato && (corriere==="Tutti" || p.corriere===corriere));
      if(ritirati.length === 0){
        alert(`Non ci sono pacchi ritirati da cancellare per ${corriere}.`);
        return;
      }
      if(confirm(`Vuoi cancellare ${ritirati.length} pacchi ritirati di ${corriere}?`)){
        pacchi = pacchi.filter(p => !(p.ritirato && (corriere==="Tutti" || p.corriere===corriere)));
        salvaDati();
        aggiornaVista();
      }
    });

    // ---- VISTA ----
    function aggiornaVista(){
      aggiornaCorrieri();
      aggiornaScaffali();
      const container = document.getElementById("pacchiContainer");
      const ritiratiCont = document.getElementById("ritiratiContainer");
      container.innerHTML="";
      ritiratiCont.innerHTML="";

      const corriereSelezionato = document.getElementById("corriereSelect").value || "Tutti";
      let attivi = pacchi.filter(p=>!p.ritirato && (corriereSelezionato==="Tutti" || p.corriere===corriereSelezionato));
      let ritirati = pacchi.filter(p=>p.ritirato && (corriereSelezionato==="Tutti" || p.corriere===corriereSelezionato));

      document.getElementById("counterAttivi").textContent = attivi.length;

      attivi.forEach(p=>{
        const div=document.createElement("div");
        div.textContent=`${p.codice} - ${p.cognome} (${p.corriere}) ${p.scaffale?"- "+p.scaffale:""}`;
        const chk=document.createElement("input");
        chk.type="checkbox";
        chk.onchange=()=>{
          p.ritirato=chk.checked;
          p.dataRitiro=new Date().toLocaleString();
          salvaDati();
          aggiornaVista();
        };
        div.appendChild(chk);
        container.appendChild(div);
      });

      ritirati.forEach(p=>{
        const div=document.createElement("div");
        div.textContent=`${p.codice} - ${p.cognome} (${p.corriere}) ${p.scaffale?"- "+p.scaffale:""} - Ritirato il ${p.dataRitiro}`;
        ritiratiCont.appendChild(div);
      });
    }

    aggiornaVista();
  </script>
</body>
</html>
