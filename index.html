<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Gestione Pacchi Postali</title>
<style>
body { font-family: 'Courier New', Courier, monospace; background-color: #fefefe; padding: 20px; background-image: url('https://www.transparenttextures.com/patterns/postcard.png'); }
h1 { text-align: center; margin-bottom: 10px; color: #333; text-transform: uppercase; letter-spacing: 2px; }
input, select, button { padding: 12px; font-size: 16px; border-radius: 6px; border: 2px dashed #ccc; background-color: #fff; }
select { min-width: 200px; }
button { background-color: #cc0000; color: white; border: none; cursor: pointer; transition: 0.2s; }
button:hover { background-color: #990000; }
.form-group { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; justify-content: center; }
.search-bar { margin: 20px auto; display: block; padding: 12px; width: 50%; border: 2px dashed #ccc; }
.tabs { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
.tabs button { background-color: #eee; border: 1px solid #ccc; color: #333; border-radius: 6px; padding: 8px 12px; }
.pacchi-list { display: flex; flex-direction: column; gap: 10px; padding: 10px; }
.pacco { background: #fff8e1; border: 2px dashed #999; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); font-weight: 600; font-size: 16px; }
.ritirato { background-color: #c8e6c9 !important; }
.corriere-btn-container { display: flex; justify-content: flex-end; margin-bottom: 10px; }
.corriere-btn { background-color: #cc0000; color: white; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: 0.2s; }
.corriere-btn:hover { background-color: #990000; }
.corriere-input { display: none; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.sezione-ritirati { margin-top: 40px; border-top: 2px dotted #aaa; padding-top: 20px; }
#toggleRitirati { cursor: pointer; user-select: none; margin-bottom: 10px; }
#ritiratiContainer { max-height: 300px; overflow: auto; transition: max-height 0.3s ease; }
.counter { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #444; }
/* LOGIN */
#loginPage { display: flex; justify-content: center; align-items: center; height: 100vh; }
.login-box { background: #fff; border: 2px dashed #cc0000; padding: 40px; border-radius: 12px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); text-align: center; width: 350px; }
.login-box input { width: 100%; margin-bottom: 15px; }
.login-box button { width: 100%; }
.remember { margin: 10px 0; font-size: 14px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-box">
    <h2>Accesso</h2>
    <input type="text" id="loginCode" placeholder="Inserisci codice">
    <div class="remember"><label><input type="checkbox" id="rememberMe"> Ricordami</label></div>
    <button onclick="login()">Entra</button>
  </div>
</div>

<!-- MAIN -->
<div id="mainPage" style="display:none;">
<h1>Gestione Pacchi Postali</h1>
<div style="text-align:right; margin-bottom:10px;">
  <button onclick="logout()" style="background-color:#555;">Logout</button>
</div>

<div class="corriere-btn-container">
  <button class="corriere-btn" onclick="toggleInputCorriere()">+</button>
</div>
<div class="corriere-input" id="corriereInputDiv">
  <input type="text" id="nuovoCorriere" placeholder="Nuovo Corriere" />
  <button onclick="aggiungiCorriere()">Aggiungi Corriere</button>
  <button onclick="rimuoviCorriere()">Rimuovi Corriere</button>
  <input type="text" id="nuovoScaffale" placeholder="Nuovo Scaffale (1-12 o Avanti)" style="width:150px;">
  <button onclick="aggiungiScaffale()">Aggiungi Scaffale</button>
  <button onclick="rimuoviScaffale()">Rimuovi Scaffale</button>
</div>

<div class="form-group">
  <input type="text" id="codiceTracciabilita" placeholder="Codice di Tracciabilità" />
  <input type="text" id="codiceRiconoscimento" placeholder="Codice di Riconoscimento (opzionale)" oninput="this.value=this.value.replace(/\D/g,'')" />
  <input type="text" id="nome" placeholder="Nome" />
  <input type="text" id="cognome" placeholder="Cognome" />
  <select id="corriereSelect"><option value="">Seleziona Corriere</option></select>
  <select id="scaffaleSelect">
  <option value="">Seleziona scaffale (opzionale)</option>
  <option value="Scaffale 1">Scaffale 1</option>
  <option value="Scaffale 2">Scaffale 2</option>
  <option value="Scaffale 3">Scaffale 3</option>
  <option value="Scaffale 4">Scaffale 4</option>
  <option value="Scaffale 5">Scaffale 5</option>
  <option value="Scaffale 6">Scaffale 6</option>
  <option value="Scaffale 7">Scaffale 7</option>
  <option value="Scaffale 8">Scaffale 8</option>
  <option value="Scaffale 9">Scaffale 9</option>
  <option value="Scaffale 10">Scaffale 10</option>
  <option value="Scaffale 11">Scaffale 11</option>
  <option value="Scaffale 12">Scaffale 12</option>
  <option value="Avanti">Avanti</option>
</select>
  <button onclick="aggiungiPacco()">Aggiungi</button>
</div>

<input type="text" id="search" class="search-bar" placeholder="Cerca per codice o cognome" oninput="aggiornaVista()" />
<div class="tabs" id="tabs"></div>
<div class="counter" id="counter"></div>
<div id="contenitori"></div>

<div class="sezione-ritirati">
  <h2 id="toggleRitirati">Pacchi Ritirati ▼</h2>
  <button id="cancellaRitiratiBtn" style="font-size:14px; padding:5px 10px; margin-bottom:10px;">Cancella pacchi ritirati</button>
  <div id="ritiratiContainer"></div>
</div>

<script>
// --- LOGIN ---
function login(){
  const codice=document.getElementById('loginCode').value.trim();
  if(codice==='2025754785478'){
    if(document.getElementById('rememberMe').checked){ localStorage.setItem('loggedIn','true'); }
    document.getElementById('loginPage').style.display='none';
    document.getElementById('mainPage').style.display='block';
    resetInattivita();
  } else { alert('Codice errato'); }
}
if(localStorage.getItem('loggedIn')==='true'){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('mainPage').style.display='block';
  resetInattivita();
}
function logout(){
  localStorage.removeItem('loggedIn');
  document.getElementById('mainPage').style.display='none';
  document.getElementById('loginPage').style.display='flex';
}

// --- TIMER INATTIVITÀ 20 MINUTI ---
let timerInattivita;
function resetInattivita(){
  clearTimeout(timerInattivita);
  timerInattivita=setTimeout(()=>{ alert('Sessione scaduta per inattività'); logout(); }, 20*60*1000);
}
['mousemove','keydown','click','scroll'].forEach(evt=>{ document.addEventListener(evt, resetInattivita); });

// --- PACCHI, CORRIERI E SCAFFALI ---
let pacchi = JSON.parse(localStorage.getItem('pacchi')) || [];
let corrieri = JSON.parse(localStorage.getItem('corrieri')) || [];
let scaffali = JSON.parse(localStorage.getItem('scaffali')) || [];

function salvaDati(){ 
  localStorage.setItem('pacchi', JSON.stringify(pacchi)); 
  localStorage.setItem('corrieri', JSON.stringify(corrieri)); 
  localStorage.setItem('scaffali', JSON.stringify(scaffali));
}

function toggleInputCorriere(){ const div=document.getElementById('corriereInputDiv'); div.style.display=div.style.display==='flex'?'none':'flex'; }

function aggiornaCorriereSelect(){
  const select=document.getElementById('corriereSelect'); select.innerHTML='<option value="">Seleziona Corriere</option>';
  corrieri.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; select.appendChild(opt); });
}

function aggiungiCorriere(){ 
  const nuovo=document.getElementById('nuovoCorriere').value.trim();
  if(nuovo && !corrieri.includes(nuovo)){ corrieri.push(nuovo); aggiornaCorriereSelect(); aggiornaVista(); salvaDati(); }
  document.getElementById('nuovoCorriere').value=''; toggleInputCorriere(); 
}
function rimuoviCorriere(){ 
  const corriere=document.getElementById('nuovoCorriere').value.trim();
  if(corriere && corrieri.includes(corriere)){
    const pacchiAssoc=pacchi.filter(p=>p.corriere===corriere);
    if(pacchiAssoc.length>0 && !confirm(`Ci sono ${pacchiAssoc.length} pacchi per questo corriere. Vuoi eliminarli anche?`)) return;
    pacchi=pacchi.filter(p=>p.corriere!==corriere);
    corrieri=corrieri.filter(c=>c!==corriere);
    aggiornaCorriereSelect(); aggiornaVista(); salvaDati();
  }
  document.getElementById('nuovoCorriere').value=''; toggleInputCorriere(); 
}

// --- SCAFFALI ---
function aggiungiScaffale(){
  const s = document.getElementById('nuovoScaffale').value.trim();
  if(s && !scaffali.includes(s)){ scaffali.push(s); salvaDati(); aggiornaVista(); }
  document.getElementById('nuovoScaffale').value='';
}
function rimuoviScaffale(){
  const s = document.getElementById('nuovoScaffale').value.trim();
  if(s && scaffali.includes(s)){ scaffali = scaffali.filter(x=>x!==s); salvaDati(); aggiornaVista(); }
  document.getElementById('nuovoScaffale').value='';
}

function aggiungiPacco(){
  const ct=document.getElementById('codiceTracciabilita').value.trim();
  const cr=document.getElementById('codiceRiconoscimento').value.trim();
  const nome=document.getElementById('nome').value.trim();
  const cognome=document.getElementById('cognome').value.trim();
  const corriere=document.getElementById('corriereSelect').value;
  const scaffale=document.getElementById('scaffaleSelect').value;

  if(!cognome || !ct){ if(!confirm('Codice tracciabilità e cognome sono obbligatori. Continuare comunque?')) return; }
  if(ct && pacchi.some(p=>p.codiceTracciabilita===ct)){ if(!confirm('Questo codice tracciabilità è già presente. Continuare?')) return; }

  const numeri=pacchi.filter(p=>p.corriere===corriere && !p.ritirato).map(p=>parseInt(p.riconoscimento)).filter(n=>!isNaN(n));
  const riconoscimento=cr || (numeri.length?Math.max(...numeri)+1:1);

  pacchi.push({
    id:Date.now(),
    codiceTracciabilita:ct||'-',
    riconoscimento,
    nome,
    cognome,
    corriere,
    scaffale: scaffale || null,
    ritirato:false,
    ritiroData:null
  });

  document.getElementById('codiceTracciabilita').value='';
  document.getElementById('codiceRiconoscimento').value='';
  document.getElementById('nome').value='';
  document.getElementById('cognome').value='';
  document.getElementById('scaffaleSelect').value='';
  aggiornaVista(); salvaDati();
}

function toggleRitirato(id){
  const pacco=pacchi.find(p=>p.id===id);
  if(pacco){
    pacco.ritirato=!pacco.ritirato;
    if(pacco.ritirato) pacco.ritiroData=new Date().toLocaleString();
    else pacco.ritiroData=null;
    salvaDati(); aggiornaVista();
  }
}

document.getElementById('cancellaRitiratiBtn').addEventListener('click', () => {
  const selezione=sessionStorage.getItem('tab')||'Tutti';
  let ritirati = selezione==='Tutti'?pacchi.filter(p=>p.ritirato):pacchi.filter(p=>p.ritirato && p.corriere===selezione);
  if(ritirati.length===0){ alert('Non ci sono pacchi ritirati da cancellare.'); return; }
  if(confirm(`Sei sicuro di voler cancellare ${ritirati.length} pacchi ritirati?`)){
    pacchi = pacchi.filter(p=>!ritirati.includes(p));
    salvaDati(); aggiornaVista();
  }
});

let ritiratiAperti=true;
document.getElementById('toggleRitirati').addEventListener('click',()=>{
  ritiratiAperti=!ritiratiAperti;
  const container=document.getElementById('ritiratiContainer');
  const titolo=document.getElementById('toggleRitirati');
  if(ritiratiAperti){ container.style.maxHeight='300px'; titolo.textContent='Pacchi Ritirati ▼'; }
  else{ container.style.maxHeight='0'; titolo.textContent='Pacchi Ritirati ▶'; }
});

function aggiornaVista(){
  aggiornaCorriereSelect();
  const search=document.getElementById('search').value.toLowerCase();
  const contenitori=document.getElementById('contenitori');
  const ritiratiContainer=document.getElementById('ritiratiContainer');
  const tabs=document.getElementById('tabs');
  const selezione=sessionStorage.getItem('tab')||'Tutti';

  tabs.innerHTML='';
  const creaTab=nome=>{ const btn=document.createElement('button'); btn.textContent=nome; btn.onclick=()=>{ sessionStorage.setItem('tab',nome); aggiornaVista(); }; if(nome===selezione) btn.style.fontWeight='bold'; tabs.appendChild(btn); }
  creaTab('Tutti'); corrieri.forEach(c=>creaTab(c));

  contenitori.innerHTML=''; ritiratiContainer.innerHTML='';

  const pacchiFiltrati=pacchi.filter(p=>p.cognome.toLowerCase().includes(search)||(''+p.riconoscimento).includes(search));
  let visibili=selezione==='Tutti'?pacchiFiltrati.filter(p=>!p.ritirato):pacchiFiltrati.filter(p=>!p.ritirato && p.corriere===selezione);
  let ritirati=selezione==='Tutti'?pacchiFiltrati.filter(p=>p.ritirato):pacchiFiltrati.filter(p=>p.ritirato && p.corriere===selezione);

  document.getElementById('counter').textContent="Pacchi in giacenza: "+visibili.length;

  const lista=document.createElement('div'); lista.className='pacchi-list';
  visibili.forEach(p=>{ const card=document.createElement('div'); card.className='pacco';
    card.innerHTML=`<div><strong>#${p.riconoscimento}</strong> - ${p.codiceTracciabilita} - ${p.nome} ${p.cognome} (${p.corriere}) ${p.scaffale?'- '+p.scaffale:''}</div>
    <label><input type="checkbox" ${p.ritirato?'checked':''} onclick="toggleRitirato(${p.id})"> Ritirato</label>`;
    lista.appendChild(card);
  });
  contenitori.appendChild(lista);

  const listaRitirati=document.createElement('div'); listaRitirati.className='pacchi-list';
  ritirati.forEach(p=>{ const card=document.createElement('div'); card.className='pacco ritirato';
    card.innerHTML=`<div><strong>#${p.riconoscimento}</strong> - ${p.codiceTracciabilita} - ${p.nome} ${p.cognome} (${p.corriere}) ${p.scaffale?'- '+p.scaffale:''} ${p.ritiroData?'- '+p.ritiroData:''}</div>
    <label><input type="checkbox" checked onclick="toggleRitirato(${p.id})"> Ritirato</label>`;
    listaRitirati.appendChild(card);
  });
  ritiratiContainer.appendChild(listaRitirati);
}

aggiornaVista();
</script>
</body>
</html>
